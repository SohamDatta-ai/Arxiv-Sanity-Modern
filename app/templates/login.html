{% extends "base.html" %}

{% block content %}
<div style="max-width: 400px; margin: 40px auto; padding: 20px; border: 1px solid #ddd; background: #fff;">
    <h2 style="margin-top: 0;">Log In</h2>

    <div id="error-msg" style="color: red; margin-bottom: 15px; display: none;"></div>

    <form hx-post="/login_or_create" hx-target="#auth-response" hx-swap="none" id="login-form">
        <label>User (Email):</label><br>
        <input type="text" name="username" style="width: 100%; padding: 5px; margin-bottom: 10px;" required><br>

        <label>Password:</label><br>
        <input type="password" name="password" style="width: 100%; padding: 5px; margin-bottom: 10px;" required><br>

        <button type="submit" style="padding: 5px 15px; cursor: pointer;">Login or Create</button>
    </form>

    <div style="margin-top: 20px; font-size: 13px; color: #666;">
        (If the account doesn't exist, it will be created automatically)
    </div>

    <!-- Hidden div to handle the response via simple JS (since we need to set localstorage) -->
    <div id="auth-response"></div>

    <script>
        document.body.addEventListener('htmx:afterRequest', function (evt) {
            if (evt.detail.path === "/login_or_create") {
                if (evt.detail.xhr.status === 200) {
                    const data = JSON.parse(evt.detail.xhr.response);
                    // Store token
                    localStorage.setItem('token', data.access_token);
                    // Reload page to update UI
                    window.location.href = "/";
                } else {
                    const errDiv = document.getElementById('error-msg');
                    errDiv.innerText = "Invalid credentials";
                    errDiv.style.display = 'block';
                }
            }
        });
    </script>
</div>
{% endblock %}